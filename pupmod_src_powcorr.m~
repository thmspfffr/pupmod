
%% pp_src_powcorr_test

% Call pupmod_all_powcorr_periphereal.m next, in order to clean
% estimated FCs from artifacts.

clear
% --------------------------------------------------------
% VERSION 1 - VOXEL LEVEL, 400 samples cortex
% --------------------------------------------------------
v               = 1;
SUBJLIST        = [4 5 6 7 8 9 10 11 12 13 15 16 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34];
allpara.filt    = 'jh_lcmv';
allpara.grid    = 'cortex_lowres';
foi_range       = 2.^[2:.25:6];
para.scnd_filt  = 0;
% --------------------------------------------------------
% VERSION 2 - AAL LEVEL (based on 6mm)
% --------------------------------------------------------
% v               = 24;
% SUBJLIST        = [4 5 6 7 8 9 10 11 12 13 15 16 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34];
% allpara.filt    = 'jh_lcmv';
% allpara.grid    = 'aal_6mm';
% foi_range       = 2.^[1:.25:7];
% para.wavelet    = 'bp_filt';
% para.scnd_filt  = 0;
% allpara.reg     = 0.05;
% allpara.weigh   = 0;
% allpara.tau     = nan;
% weighting       = 1;
% width           = 4;
% --------------------------------------------------------

if strcmp(allpara.grid,'xcoarse')
  v_grid = 2;
elseif strcmp(allpara.grid,'cortex')
  v_grid = 3;
elseif strcmp(allpara.grid,'aal')
  v_grid = 4;
elseif strcmp(allpara.grid,'medium')
  v_grid = 5;
elseif strcmp(allpara.grid,'aal_6mm')
  v_grid = 6;
elseif strcmp(allpara.grid,'aal_4mm')
  v_grid = 7;
elseif strcmp(allpara.grid,'m758_4mm')
  v_grid = 8;
elseif strcmp(allpara.grid, 'cortex_lowres')
  v_grid = 9;
elseif strcmp(allpara.grid,'genemaps')
  v_grid = 13;
elseif strcmp(allpara.grid,'genemaps_aal')
  v_grid = 14;
elseif strcmp(allpara.grid,'cortex800')
  v_grid = 16;
end

addpath /home/gnolte/meg_toolbox/toolbox/
addpath /home/gnolte/meg_toolbox/fieldtrip_utilities/
addpath /home/gnolte/meg_toolbox/toolbox_nightly/
addpath /home/gnolte/meg_toolbox/meg/

ft_defaults()
outdir   = '/home/tpfeffer/pupmod/proc/conn/';
addpath /home/tpfeffer/pconn/matlab/

ord   = pconn_randomization;
%% LOAD DATA COMPUTE SRC TIME COURSES

for isubj = SUBJLIST
  for m = 1:3
    %
%     if ~exist(sprintf([outdir 'pupmod_src_powcorr_s%d_m%d_v%d_processing.txt'],isubj,m,v))
%       system(['touch ' outdir sprintf('pupmod_src_powcorr_s%d_m%d_v%d_processing.txt',isubj,m,v)]);
%     else
%       continue
%     end
    
    if strcmp(allpara.grid,'cortex_lowres')
      powcorr = nan(400,400,2,length(foi_range));
    else
      powcorr = nan(90,90,2,length(foi_range));
    end
    
    for iblock = 1:2
      
      % --
      % Load sensor level data
      try
        load(sprintf('~/pupmod/proc/sens/pupmod_rest_sens_cleandat_s%d_m%d_b%d_v%d.mat',isubj,m,iblock,1))
      catch me
        if ~exist(sprintf('~/pupmod/proc/pupmod_rest_sens_cleandat_s%d_m%d_b%d_v%d.mat',isubj,m,iblock,1))
          continue
        else
          error('Data corrupt?')
        end
      end
      
      % Load source model
      % ------------
      sa        = load(sprintf('~/pconn/proc/src/pconn_sa_s%d_m%d_b%d_v%d.mat',isubj,m,iblock,v_grid));
      % ------------

      for ifoi = 1 : length(foi_range)
        
        fprintf('Processing s%d m%d b%d f%d  ...\n', isubj,m,iblock,ifoi)
        
        % Compute cross spectrum (using wavelets)
        % ------------
        para            = [];
        para.freq       = foi_range(ifoi);
        para.fsample    = 400;
        [cs,nan_count]  = tp_compute_csd_wavelets(dat,para);
        % ------------
        % Compute spatial filter (LCMV)
        % ------------
        para            = [];
        para.iscs       = 1;
        para.reg        = 0.05;
        filt      = pconn_beamformer(real(cs),sprintf('sa.sa.L_%s',allpara.grid),para);
        % ------------
%       aal_label = sa.aal_label;
        
        % Compute imaginary coherence first
%         csd_src = filt'*cs*filt;
%         c = csd_src / sqrt(diag(csd_src)*diag(csd_src)');
        % ------------
        % Compute orthogonalized power enevelope correlations 
        % ------------
        powcorr(:,:,iblock,ifoi) = tp_data2orthopowcorr_wavelet(data,foi_range(ifoi),filt);
        % ------------

      end 
    end
    
    save(sprintf([outdir 'pupmod_src_powcorr_s%d_m%d_v%d.mat'],isubj,m,v),'powcorr','nan_count');
    
    clear powcorr sa cs pars para
    
  end
end
error('!')

%%
% ord = pconn_randomization;
% 
% for isubj = SUBJLIST
%   isubj
%   for m = 1 : 3
%     im = find(ord(isubj,:)==m);
%     
%     load(sprintf('/home/tpfeffer/pp/proc/conn/pp_cnt_src_powcorr_test_s%d_m%d_v43.mat',isubj,im))
%     
%     allpow(:,:,isubj,m,2,:) = squeeze(nanmean(powcorr,3));
%     
%     load(sprintf('/home/tpfeffer/pp/proc/conn/pp_src_powcorr_test_s%d_m%d_v43.mat',isubj,im))
%     
%     allpow(:,:,isubj,m,1,:) = squeeze(nanmean(powcorr,3));
%     
%   end
% end
% 
% 
% allpow = allpow(:,:,SUBJLIST,:,:,:);

