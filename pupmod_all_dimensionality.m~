% %% pupmod_src_powcorr_plot
% COMPUTES THE NUMBER OF ALTERED CORRELATIONS AS A FUNCTION OF
% CARRIER FREQUENCY.

% Last changed: 13-11-2018

clear

v = 23;

addpath /home/gnolte/meg_toolbox/toolbox/
addpath /home/gnolte/meg_toolbox/fieldtrip_utilities/
addpath /home/gnolte/meg_toolbox/toolbox_nightly/
addpath /home/gnolte/meg_toolbox/meg/
addpath(genpath('/home/gnolte/meth'));

load sa_meg_template;

fprintf('Loading grid...\n')
grid  = select_chans(sa_meg_template.grid_cortex3000,400); fprintf('Loading grid... Done\n')
SUBJLIST  = [4 5 6 7 8 9 10 11 12 13 15 16 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34];

fc = pupmod_loadpowcorr(v,SUBJLIST,0);

if v == 20
  tmp = tp_create_grid('vtpm');
  clim = [-0.025 0.025];
  idx = 1:46;
  iismember(idx,[21 22 23 44 45 46]);
  reg = tmp.tissuelabel_4mm(idx);
end


%% COMPUTE DIMENSIONALITY
dim = zeros(28,3,2,25);
for isubj = 1:28
  isubj
  cnt = 0;
  for m = 1 : 3
    for ifoi=1:25
      for cond = 1 : 2
%         cnt=cnt+1
        % compute according to ito et al. (2019) biorxiv
        [a,b,eig]=pca(nanmean(fc(:,:,isubj,m,cond,ifoi,:),7));
        dim(isubj,m,cond,ifoi)=(sum(eig)^2)/(sum(eig.^2));
        
      end
    end
  end
end

%% PLOT

figure; set(gcf,'color','w');
ipharm = 1;
subplot(3,2,1); hold on; title('Placebo')
plot(squeeze(nanmean(nanmean(dim(:,ipharm,1:2,:)),2))')
[h1,p1]=ttest(squeeze(nanmean(dim(:,ipharm,2,:),2)),squeeze(nanmean(dim(:,ipharm,1,:),2)),'dim',1);
plot(find(h1),ones(sum(h1)),'.','markersize',5,'color','k'),
tp_editplots;  xlabel('Frequency [Hz]'); ylabel('W')
set(gca,'tickdir','out','xtick',[1 5 9 13 17 21 25],'xticklabel',[2 4 8 16 32 64 128])
axis([0 25 0 15])

ipharm = 2;
subplot(3,2,3); hold on; title('Atomoxetine')
plot(squeeze(nanmean(nanmean(dim(:,ipharm,1:2,:)),2))')
[h2,p2]=ttest(squeeze(nanmean(dim(:,ipharm,2,:),2)),squeeze(nanmean(dim(:,ipharm,1,:),2)),'dim',1);
plot(find(h2),ones(sum(h2)),'.','markersize',5,'color','k'),
tp_editplots; xlabel('Frequency [Hz]'); ylabel('W')
set(gca,'tickdir','out','xtick',[1 5 9 13 17 21 25],'xticklabel',[2 4 8 16 32 64 128])
axis([0 25 0 15])

ipharm = 3;
subplot(3,2,5); hold on; title('Donepezil')
plot(squeeze(nanmean(nanmean(dim(:,ipharm,1:2,:)),2))')
[h3,p3]=ttest(squeeze(nanmean(dim(:,ipharm,2,:),2)),squeeze(nanmean(dim(:,ipharm,1,:),2)),'dim',1);
plot(find(h3),ones(sum(h3)),'.','markersize',5,'color','k'),
tp_editplots;  xlabel('Frequency [Hz]'); ylabel('W')
set(gca,'tickdir','out','xtick',[1 5 9 13 17 21 25],'xticklabel',[2 4 8 16 32 64 128])
axis([0 25 0 15])

subplot(3,2,2); hold on; title('Average')
plot(squeeze(nanmean(nanmean(dim(:,1:3,1:2,:)),2))')
[h_avg,p_avg]=ttest(squeeze(nanmean(dim(:,1:3,2,:),2)),squeeze(nanmean(dim(:,1:3,1,:),2)),'dim',1);
plot(find(h_avg),ones(sum(h_avg)),'.','markersize',5,'color','k'),
tp_editplots;  xlabel('Frequency [Hz]'); ylabel('W')
set(gca,'tickdir','out','xtick',[1 5 9 13 17 21 25],'xticklabel',[2 4 8 16 32 64 128])
axis([0 25 0 15])

subplot(3,2,4); hold on; title('Atx vs Pbo (Task)')
plot(squeeze(nanmean(dim(:,[1 2],2,:)))')
[h_atx,p_atx]=ttest(squeeze(nanmean(dim(:,2,2,:),2)),squeeze(nanmean(dim(:,1,2,:),2)),'dim',1);
plot(find(h_atx),ones(sum(h_atx)),'.','markersize',5,'color','k'),
tp_editplots;  xlabel('Frequency [Hz]'); ylabel('W')
set(gca,'tickdir','out','xtick',[1 5 9 13 17 21 25],'xticklabel',[2 4 8 16 32 64 128])
axis([0 25 0 15])

subplot(3,2,6); hold on; title('Dpz vs Pbo (Rest)')
plot(squeeze(nanmean(dim(:,[1 3],1,:)))')
[h_dpz,p_dpz]=ttest(squeeze(nanmean(dim(:,3,1,:),2)),squeeze(nanmean(dim(:,1,1,:),2)),'dim',1);
plot(find(h_dpz),ones(sum(h_dpz)),'.','markersize',5,'color','k'),
tp_editplots;  xlabel('Frequency [Hz]'); ylabel('W')
set(gca,'tickdir','out','xtick',[1 5 9 13 17 21 25],'xticklabel',[2 4 8 16 32 64 128])
axis([0 25 0 15])

print(gcf,'-dpdf',sprintf('~/pupmod/plots/pupmod_all_dimensionality_v%d.pdf',v))

%% PLOT MEAN FC AS COMPARISON
fc1 = squeeze(nanmean(nanmean(nanmean(fc,1),2),7));

figure; set(gcf,'color','w');
ipharm = 1;
subplot(3,2,1); hold on; title('Placebo')
plot(squeeze(nanmean(nanmean(fc1(:,ipharm,1:2,:)),2))')
[h1,p1]=ttest(squeeze(nanmean(fc1(:,ipharm,2,:),2)),squeeze(nanmean(fc1(:,ipharm,1,:),2)),'dim',1);
k=plot(find(h1),0*ones(sum(h1)),'.','markersize',5,'color','k'),
tmp=get(k); tmp.Annotation.LegendInformation.IconDisplayStyle='off';
legend(k,{'b';'a'}); %legend boxoff

tp_editplots;  xlabel('Frequency [Hz]'); ylabel('W')
set(gca,'tickdir','out','xtick',[1 5 9 13 17 21 25],'xticklabel',[2 4 8 16 32 64 128])
axis([0 25 -0.01 .15])

ipharm = 2;
subplot(3,2,3); hold on; title('Atomoxetine')
plot(squeeze(nanmean(nanmean(fc1(:,ipharm,1:2,:)),2))')
[h2,p2]=ttest(squeeze(nanmean(fc1(:,ipharm,2,:),2)),squeeze(nanmean(fc1(:,ipharm,1,:),2)),'dim',1);
plot(find(h2),0*ones(sum(h2)),'.','markersize',5,'color','k'),
tp_editplots; xlabel('Frequency [Hz]'); ylabel('W')
set(gca,'tickdir','out','xtick',[1 5 9 13 17 21 25],'xticklabel',[2 4 8 16 32 64 128])
axis([0 25 -0.01 .15])

ipharm = 3;
subplot(3,2,5); hold on; title('Donepezil')
plot(squeeze(nanmean(nanmean(fc1(:,ipharm,1:2,:)),2))')
[h3,p3]=ttest(squeeze(nanmean(fc1(:,ipharm,2,:),2)),squeeze(nanmean(fc1(:,ipharm,1,:),2)),'dim',1);
plot(find(h3),0*ones(sum(h3)),'.','markersize',5,'color','k'),
tp_editplots;  xlabel('Frequency [Hz]'); ylabel('W')
set(gca,'tickdir','out','xtick',[1 5 9 13 17 21 25],'xticklabel',[2 4 8 16 32 64 128])
axis([0 25 -0.01 .15])

subplot(3,2,2); hold on; title('Average')
plot(squeeze(nanmean(nanmean(fc1(:,1:3,1:2,:)),2))')
[h_avg,p_avg]=ttest(squeeze(nanmean(fc1(:,1:3,2,:),2)),squeeze(nanmean(fc1(:,1:3,1,:),2)),'dim',1);
plot(find(h_avg),0*ones(sum(h_avg)),'.','markersize',5,'color','k'),
tp_editplots;  xlabel('Frequency [Hz]'); ylabel('W')
set(gca,'tickdir','out','xtick',[1 5 9 13 17 21 25],'xticklabel',[2 4 8 16 32 64 128])
axis([0 25 -0.01 .15])

subplot(3,2,4); hold on; title('Atx vs Pbo (Task)')
plot(squeeze(nanmean(fc1(:,[1 2],2,:)))')
[h_atx,p_atx]=ttest(squeeze(nanmean(fc1(:,2,2,:),2)),squeeze(nanmean(fc1(:,1,2,:),2)),'dim',1);
plot(find(h_atx),0*ones(sum(h_atx)),'.','markersize',5,'color','k'),
tp_editplots;  xlabel('Frequency [Hz]'); ylabel('W')
set(gca,'tickdir','out','xtick',[1 5 9 13 17 21 25],'xticklabel',[2 4 8 16 32 64 128])
axis([0 25 -0.01 .15])

subplot(3,2,6); hold on; title('Dpz vs Pbo (Rest)')
plot(squeeze(nanmean(fc1(:,[1 3],1,:)))')
[h_dpz,p_dpz]=ttest(squeeze(nanmean(fc1(:,3,1,:),2)),squeeze(nanmean(fc1(:,1,1,:),2)),'dim',1);
plot(find(h_dpz),0*ones(sum(h_dpz)),'.','markersize',5,'color','k'),
tp_editplots;  xlabel('Frequency [Hz]'); ylabel('W')
set(gca,'tickdir','out','xtick',[1 5 9 13 17 21 25],'xticklabel',[2 4 8 16 32 64 128])
axis([0 25 -0.01 .15])

print(gcf,'-dpdf',sprintf('~/pupmod/plots/pupmod_all_dimensionality_fc_v%d.pdf',v))

